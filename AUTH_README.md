# DSpace Dashboard - Инструкция по авторизации

## Описание

Dashboard защищён авторизацией через DSpace REST API. Доступ имеют только пользователи с правами администратора.

## Вход в систему

1. Откройте dashboard по адресу: `https://your-domain.com/dspace-dashboard/`
2. Вы будете автоматически перенаправлены на страницу входа
3. Введите email и пароль от вашей учётной записи DSpace
4. После успешной авторизации система проверит, что вы являетесь администратором
5. При успешной проверке вы получите доступ к dashboard

## Требования для доступа

- Учётная запись в DSpace
- Членство в группе Administrator
- Доступ к `local.cfg` (см. ниже) и корректные переменные окружения

## Настройка переменных окружения

В файле `/etc/default/dspace-dashboard` должны быть указаны:

```bash
# Путь к DSpace local.cfg
DSPACE_CONFIG_PATH="/dspace/config/local.cfg"

# Секретный ключ для Flask сессий
SECRET_KEY="ваш_случайный_ключ_64_символа"

# (Опционально) Список email администраторов через запятую
# Используется как fallback если API не возвращает группы
ADMIN_EMAILS="admin@example.com,manager@example.com"
```

## Что нужно в local.cfg

Для авторизации используется ключ `dspace.server.url`, на его основе формируется REST API:

```properties
# Базовый URL вашей установки DSpace
dspace.server.url = https://repository.example.edu
```

## Как работает авторизация

1. **Вход**: Пользователь вводит email и пароль
2. **CSRF токен**: Запрашиваем `/api/authn/status` для получения CSRF токена
3. **Проверка в DSpace**: Отправляется POST запрос на `/api/authn/login` с CSRF токеном
4. **Получение токена**: При успешной авторизации получаем JWT токен
5. **Проверка статуса**: Запрашиваем `/api/authn/status` для получения данных пользователя
6. **Проверка прав**: Проверяем принадлежность к группе Administrator
7. **Создание сессии**: При успехе создаём сессию Flask-Login

## Выход из системы

Нажмите кнопку "Вийти" в навигационном меню или перейдите по адресу `/logout`

## Безопасность

- Все данные передаются через HTTPS
- Токены хранятся только в серверной сессии
- Сессия автоматически истекает при закрытии браузера (можно настроить)
- При выходе токен аннулируется в DSpace через `/api/authn/logout`

## Отладка проблем авторизации

### Проблема: "Невірний email або пароль"

- Проверьте правильность ввода учётных данных
- Убедитесь, что учётная запись существует в DSpace
- Проверьте логи: `sudo journalctl -u dspace-dashboard -n 50`

### Проблема: "Доступ тільки для адміністраторів"

- Убедитесь, что ваш пользователь входит в группу "Administrator" в DSpace
- Проверьте переменную `ADMIN_EMAILS` в конфигурации
- Проверьте логи для деталей проверки прав

### Проблема: "Помилка авторизації"

- Проверьте доступность DSpace REST API
- Убедитесь, что `dspace.server.url` задан в `local.cfg` и `DSPACE_CONFIG_PATH` указывает на него
- Проверьте сетевое подключение между dashboard и DSpace

### Проверка конфигурации

```bash
# Проверить переменные окружения
cat /etc/default/dspace-dashboard

# Проверить доступность local.cfg
cat $DSPACE_CONFIG_PATH

# Проверить статус службы
sudo systemctl status dspace-dashboard

# Посмотреть последние логи
sudo journalctl -u dspace-dashboard -f
```

## Технические детали

- **Flask-Login**: Управление сессиями пользователей
- **DSpace REST API**: Авторизация и проверка прав
- **JWT токены**: Безопасная передача данных
- **Server-side sessions**: Хранение токенов на сервере

## Модули авторизации

- `auth_dspace.py` - Функции для работы с DSpace REST API
- `app.py` - Маршруты /login, /logout и защита страниц
- `templates/login.html` - Страница входа
- `templates/base.html` - Кнопка выхода в навигации
