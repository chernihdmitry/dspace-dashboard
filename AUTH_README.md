# DSpace Dashboard - Инструкция по авторизации

## Описание

Dashboard защищён авторизацией через DSpace REST API. Доступ имеют только пользователи с правами администратора.

## Вход в систему

1. Откройте dashboard по адресу: `https://your-domain.com/dspace-dashboard/`
2. Вы будете автоматически перенаправлены на страницу входа
3. Введите email и пароль от вашей учётной записи DSpace
4. После успешной авторизации система проверит, что вы являетесь администратором
5. При успешной проверке вы получите доступ к dashboard

## Требования для доступа

- Учётная запись в DSpace
- Членство в группе Administrator
- Корректные переменные окружения (см. ниже)

## Настройка переменных окружения

В файле `/etc/default/dspace-dashboard` должны быть указаны:

```bash
# Базовый URL вашей установки DSpace
REST_BASE_URL="https://repository.kpi.kharkov.ua"

# Путь к REST API (обычно /server/api)
DSPACE_API_ROOT="/server/api"

# Секретный ключ для Flask сессий (генерируется автоматически)
SECRET_KEY="ваш_случайный_ключ_64_символа"

# (Опционально) Список email администраторов через запятую
# Используется как fallback если API не возвращает группы
ADMIN_EMAILS="admin@example.com,manager@example.com"
```

## Как работает авторизация

1. **Вход**: Пользователь вводит email и пароль
2. **Проверка в DSpace**: Отправляется POST запрос на `/server/api/authn/login`
3. **Получение токена**: При успешной авторизации получаем JWT токен
4. **Проверка статуса**: Запрашиваем `/server/api/authn/status` для получения данных пользователя
5. **Проверка прав**: Проверяем принадлежность к группе Administrator
6. **Создание сессии**: При успехе создаём сессию Flask-Login

## Выход из системы

Нажмите кнопку "Вийти" в навигационном меню или перейдите по адресу `/logout`

## Безопасность

- Все данные передаются через HTTPS
- Токены хранятся только в серверной сессии
- Сессия автоматически истекает при закрытии браузера (можно настроить)
- При выходе токен аннулируется в DSpace через `/server/api/authn/logout`

## Отладка проблем авторизации

### Проблема: "Невірний email або пароль"

- Проверьте правильность ввода учётных данных
- Убедитесь, что учётная запись существует в DSpace
- Проверьте логи: `sudo journalctl -u dspace-dashboard -n 50`

### Проблема: "Доступ тільки для адміністраторів"

- Убедитесь, что ваш пользователь входит в группу "Administrator" в DSpace
- Проверьте переменную `ADMIN_EMAILS` в конфигурации
- Проверьте логи для деталей проверки прав

### Проблема: "Помилка авторизації"

- Проверьте доступность DSpace REST API
- Убедитесь, что `REST_BASE_URL` и `DSPACE_API_ROOT` указаны правильно
- Проверьте сетевое подключение между dashboard и DSpace

### Проверка конфигурации

```bash
# Проверить переменные окружения
cat /etc/default/dspace-dashboard

# Проверить статус службы
sudo systemctl status dspace-dashboard

# Посмотреть последние логи
sudo journalctl -u dspace-dashboard -f
```

## Технические детали

- **Flask-Login**: Управление сессиями пользователей
- **DSpace REST API**: Авторизация и проверка прав
- **JWT токены**: Безопасная передача данных
- **Server-side sessions**: Хранение токенов на сервере

## Модули авторизации

- `auth_dspace.py` - Функции для работы с DSpace REST API
- `app.py` - Маршруты /login, /logout и защита страниц
- `templates/login.html` - Страница входа
- `templates/base.html` - Кнопка выхода в навигации
