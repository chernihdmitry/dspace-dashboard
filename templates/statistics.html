{% extends "base.html" %}
{% block page_title %}Завантаження — {% if month == 0 %}{{ month_name }}{% else %}{{ month_name }} {{ year }}{% endif %}{% endblock %}
{% block page_hint %}
  <div class="text-secondary small">Показуємо перегляди сторінок документів та завантаження файлів за вибраний період.</div>
{% endblock %}

{% block content %}
{% if error %}
<div class="alert alert-danger">
  <div class="fw-semibold">Помилка</div>
  <pre class="mb-0 small" style="white-space:pre-wrap">{{ error }}</pre>
</div>
{% endif %}

<form class="card card-soft mb-3" id="periodForm">
  <div class="card-body d-flex flex-wrap gap-2 align-items-end">
    <div>
      <label class="form-label small text-secondary mb-1">Рік</label>
      <select class="form-select" id="yearSel">
        {% for y in years %}
          <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <div>
      <label class="form-label small text-secondary mb-1">Місяць</label>
      <select class="form-select" id="monthSel">
        <option value="0" {% if selected_month == 0 %}selected{% endif %}>Усі</option>
        {% for m in months %}
          <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>
            {{ "%02d"|format(m) }} — {{ month_names[m] }}
          </option>
        {% endfor %}
      </select>
    </div>

    <button type="submit" class="btn btn-primary ms-auto">Показати</button>

    <a class="btn btn-outline-secondary"
       href="{{ url_for('statistics_period', year=today_year, month=today_month) }}">
      Поточний місяць
    </a>

    <a class="btn btn-outline-info"
       href="{{ url_for('statistics_dynamics', year=selected_year) }}">
      <i class="bi bi-graph-up"></i> Динаміка
    </a>
  </div>
</form>

<script>
  document.getElementById('periodForm').addEventListener('submit', function(e){
    e.preventDefault();
    const y = document.getElementById('yearSel').value;
    const m = document.getElementById('monthSel').value;

    const base = {{ url_for('statistics_period', year=0, month=0)|tojson }};
    window.location.href = base.replace('/0/0', `/${y}/${m}`);
  });
</script>

<div class="text-secondary small mb-2">
  Період: <span class="fw-semibold">{% if month == 0 %}{{ month_name }}{% else %}{{ month_name }} {{ year }}{% endif %}</span>
</div>

<div class="card card-soft">
  <div class="card-body">
    {% if month == 0 %}
      {# Таблица по месяцам для всего года #}
      {% if months_data|length > 0 %}
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr class="text-secondary small">
              <th>Місяць</th>
              <th class="text-end">Перегляди</th>
              <th class="text-end">Завантаження</th>
            </tr>
          </thead>
          <tbody>
            {% set ns = namespace(total_views=0, total_downloads=0) %}
            {% for d in months_data %}
              {% set ns.total_views = ns.total_views + d.views %}
              {% set ns.total_downloads = ns.total_downloads + d.downloads %}
              <tr>
                <td>{{ month_names[d.month] }}</td>
                <td class="fw-semibold text-end">{{ d.views|fmt }}</td>
                <td class="fw-semibold text-end">{{ d.downloads|fmt }}</td>
              </tr>
            {% endfor %}
            <tr class="table-active border-top border-2">
              <td class="fw-bold">Усього</td>
              <td class="fw-bold text-end">{{ ns.total_views|fmt }}</td>
              <td class="fw-bold text-end">{{ ns.total_downloads|fmt }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      {% else %}
        <div class="text-secondary">Немає даних</div>
      {% endif %}
    {% else %}
      {# Карточки для конкретного месяца #}
      <div class="row g-3">
        <div class="col-md-6">
          <div class="p-3 bg-light rounded">
            <div class="small text-secondary">Перегляди</div>
            <div class="h4 mb-0 fw-bold">{{ stats.views|fmt }}</div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="p-3 bg-light rounded">
            <div class="small text-secondary">Завантаження</div>
            <div class="h4 mb-0 fw-bold">{{ stats.downloads|fmt }}</div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
